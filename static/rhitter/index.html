<html>
<head>

	<!-- Latest compiled and minified CSS -->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">

	<!-- Optional theme -->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap-theme.min.css">

	<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>

	<!-- Latest compiled and minified JavaScript -->
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>

	<script type="text/javascript" src="/static/rhitter/bootbox.min.js"></script>


	<title>RHITter #Trending</title>
</head>
<body>
	<nav class="navbar navbar-default">
		<div class="container-fluid">
			<!-- Brand and toggle get grouped for better mobile display -->
			<div class="navbar-header">
				<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
					<span class="sr-only">Toggle navigation</span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
				</button>
				<a class="navbar-brand" href="/static/rhitter/index.html">RHITter</a>
			</div>

			<!-- Collect the nav links, forms, and other content for toggling -->
			<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
				<ul class="nav navbar-nav">
					<li class="">
						<a href="#">Link <span class="sr-only">(current)</span></a>
					</li>
				</ul>
				<div id="session-navbar">
					<ul class="nav navbar-nav navbar-right">
						<li>
							<button id="sign-up" type="button" class="btn btn-default navbar-btn" data-toggle="modal" data-target="#register-modal" >Sign Up</button>
						</li>
					</ul>
					<form id="login-form" class="navbar-form navbar-right" method="post" action="/rhitter/login/">
						<div class="form-group">
							<input type="text" name="username" class="form-control" placeholder="User">
							<input type="password" name="password" class="form-control" placeholder="Password">
						</div>
						<button type="submit" class="btn btn-default">Submit</button>
					</form>
				</div>

			</div><!-- /.navbar-collapse -->
		</div><!-- /.container-fluid -->
	</nav>

	<div class="container">
		<h1>Content Goes Here</h1>
	</div>

	<div class="modal fade" id="register-modal" tabindex="-1" role="dialog">
		<div class="modal-dialog">
			<form class="form-horizontal" id="register-form" method="post" action="/rhitter/register/">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
						<h4 class="modal-title">Register For RHITter</h4>
					</div>
					<div class="modal-body">
						<p>Please fill in this information...</p>
						<div class="form-group">
							<label for="input-register-username" class="col-sm-2 contorl-label">Username</label>
							<div class="col-sm-10">
								<input type="text" class="form-control" id="input-register-username" name="input-register-username">
							</div>
						</div>

						<div class="form-group">
							<label for="input-register-password" class="col-sm-2 contorl-label">Password</label>
							<div class="col-sm-10">
								<input type="password" class="form-control" id="input-register-password" name="input-register-password">
							</div>
						</div>
					</form>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
					<input type="submit" class="btn btn-primary" value="Register" />
				</div>
			</div><!-- /.modal-content -->
		</form>
	</div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<script type="text/javascript">
$('#login-form').submit(function(){
	var form = {username: $('[name=username]').val(), password: $('[name=password]').val()};
	login(form['username'], form['password']);

	return false;
});

function login(username, password){
	var payload = {username: username, password: password};
	$.ajax({
		type: $('#login-form')[0].method,
		url: $('#login-form')[0].action,
		data: JSON.stringify(payload),
		success: function (data) {
			var response = JSON.parse(data);
			var token = response['token'];
			var userId = response['user_id'];

			loggedIn({username: username, userId: userId}, token);
		},
		error: function(data){
			bootbox.alert("The credentials you provided did not match an existing user.  Please try again or register.");
		}
	});
}

$('#register-form').submit(function(){

	var form = {username: $('[name=input-register-username]').val(), password: $('[name=input-register-password]').val()};

	console.log("Form data:");
	console.log(form);

	$.ajax({
		type: this.method,
		url: this.action,
		data: JSON.stringify(form),
		success: function(data){
			var user = JSON.parse(data);
			bootbox.alert("Your account was successfully created.")

			login(user['username'], user['password']);

			$('#register-modal').modal('hide');
		},
		error: function(data){
			var response = JSON.parse(data.responseText);
			var errorMsg = "There was an error while processing your request.  Please try not to fail at typing data into a form.";
			if (response['reason'] !== undefined){
				errorMsg = response['reason'];
			}

			bootbox.alert(errorMsg);
		}
	});

	return false;
});

function loggedIn(user, token){
	var lst = $('<ul>').addClass('nav navbar-nav navbar-right');
	lst.append($('<li>').append($('<a>').text(username)));

	$('#session-navbar').empty().append(lst);

	if(typeof(sessionStorage) === 'undefined'){
		bootbox.alert("Your browser does not support HTML5 sessionStorage.  This website won't work.  Please upgrade your browser experience with IE11.");
		return;
	}

	var username = user['username'];
	var userId = user['id'];

	sessionStorage.setItem("user", username);
	sessionStorage.setItem("userId", userId);
	sessionStorage.setItem("token", token);
}
</script>
</body>
</html>